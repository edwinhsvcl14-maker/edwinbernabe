<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de C칩digos QR Simple</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuraci칩n del tema de Tailwind -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilo para que el contenedor del esc치ner sea visible cuando se active */
        .scanner-container {
            display: none;
        }
        /* A침adido para forzar la visibilidad del video */
        #qr-reader video {
            width: 100% !important;
            height: auto !important;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-lg bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">
            Escaner de C칩digo QRwwwwwwwwwwwww
        </h1>

        <!-- Opci칩n 1: Bot칩n de Inicio (Visible por defecto) -->
        <div id="start-screen" class="text-center p-8">
            <p class="text-gray-600 mb-8">
                Presiona el bot칩n para activar tu c치mara y comenzar a escanear.
            </p>
            <button id="start-button" 
                    class="w-full max-w-xs bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-lg transform hover:scale-105"
                    onclick="startScanning()">
                Escanear C칩digo QRwwwwwwwwwwwww
            </button>
        </div>

        <!-- Opci칩n 2: Contenedor del Lector QR (Inicialmente oculto) -->
        <div id="scanner-view" class="scanner-container">
            <p class="text-center text-gray-500 mb-6">
                Apunta la c치mara al c칩digo.
            </p>
            <div id="qr-reader" class="w-full rounded-lg overflow-hidden shadow-inner bg-gray-100 p-2 border border-gray-300">
                <!-- El video del esc치ner se insertar치 aqu칤 -->
            </div>

            <!-- Secci칩n de Resultados -->
            <div class="mt-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">Resultado del Escaneo</h2>
                
                <div id="qr-reader-results" class="bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300 min-h-[5rem] flex items-center justify-center">
                    <p id="result-text" class="text-gray-500 italic">Esperando escaneo...</p>
                </div>

                <!-- Bot칩n para copiar resultado -->
                <button id="copy-button" 
                        class="hidden mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition duration-150 ease-in-out shadow-md"
                        onclick="copyToClipboard()">
                    Copiar Texto Escaneado
                </button>
                
                <!-- Nuevo bot칩n para cambiar de c치mara -->
                <button id="toggle-camera-button" 
                        class="hidden mt-2 w-full bg-indigo-400 hover:bg-indigo-500 text-white font-semibold py-2 rounded-lg transition duration-150 ease-in-out shadow-md"
                        onclick="toggleCamera()">
                    Cambiar a C치mara Frontal
                </button>

                <!-- Bot칩n para detener el escaneo -->
                <button id="stop-button" 
                        class="mt-2 w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg transition duration-150 ease-in-out shadow-md"
                        onclick="stopScanning()">
                    Detener Escaneo y Volver
                </button>
            </div>
        </div>
        
        <!-- Mensaje de Error (Inicialmente oculto) -->
        <div id="error-message" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Error al acceder a la c치mara.</strong>
            <span id="error-details" class="block sm:inline"></span>
            <p class="mt-2 text-sm font-semibold">
                丘멆잺 Si el permiso no aparece (el di치logo de la c치mara), el navegador lo tiene bloqueado. Por favor, haz clic en el <span class="font-bold">s칤mbolo de candado (游)</span> en la barra de URL y cambia el permiso de "C치mara" a <span class="font-bold">"Preguntar"</span> o <span class="font-bold">"Permitir"</span>, luego recarga la p치gina.
            </p>
        </div>
    </div>

    <!-- Script de la Librer칤a html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

    <script>
        // Inicializaci칩n de constantes y elementos
        const startScreen = document.getElementById('start-screen');
        const scannerView = document.getElementById('scanner-view');
        const qrCodeResultDiv = document.getElementById('qr-reader-results');
        const resultTextElement = document.getElementById('result-text');
        const copyButton = document.getElementById('copy-button');
        const errorMessageDiv = document.getElementById('error-message');
        const errorDetailsSpan = document.getElementById('error-details');
        const toggleCameraButton = document.getElementById('toggle-camera-button');
        
        // Estado de la c치mara
        let html5Qrcode = null; 
        let isFrontCamera = false;
        let allCameras = []; // Almacenar치 la lista de c치maras si la detecci칩n es exitosa.

        // --- FUNCIONES DE L칍GICA ---

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`, decodedResult);
            // Mostrar el resultado como un enlace clickeable
            resultTextElement.innerHTML = `<a href="${decodedText}" target="_blank" class="text-indigo-600 hover:text-indigo-800 break-words">${decodedText}</a>`;
            qrCodeResultDiv.classList.add('bg-green-50');
            copyButton.classList.remove('hidden');
            copyButton.setAttribute('data-text', decodedText);
        }

        function onScanFailure(error) {
            // Manejo de errores de escaneo (cuando no se detecta QR)
        }

        function showError(message) {
            errorDetailsSpan.innerHTML = message;
            errorMessageDiv.classList.remove('hidden');
        }

        window.copyToClipboard = function() {
            const textToCopy = copyButton.getAttribute('data-text');
            const tempInput = document.createElement('textarea');
            document.body.appendChild(tempInput);
            tempInput.value = textToCopy;
            tempInput.select();
            
            try {
                // Comando cl치sico para asegurar la compatibilidad en entornos iframe
                document.execCommand('copy'); 
                copyButton.textContent = '춰Copiado!';
                setTimeout(() => {
                    copyButton.textContent = 'Copiar Texto Escaneado';
                }, 1500);
            } catch (err) {
                console.error('No se pudo copiar el texto:', err);
                copyButton.textContent = 'Error al Copiar';
            } finally {
                document.body.removeChild(tempInput);
            }
        }

        window.stopScanning = async function() {
            if (html5Qrcode && html5Qrcode.isScanning) {
                try {
                    await html5Qrcode.stop();
                    html5Qrcode = null;
                } catch (err) {
                    console.warn("Error al detener el esc치ner (puede que ya estuviera detenido):", err);
                }
            }
            // Restaurar la interfaz y estado
            scannerView.style.display = 'none';
            startScreen.style.display = 'block';
            errorMessageDiv.classList.add('hidden');
            qrCodeResultDiv.classList.remove('bg-green-50');
            resultTextElement.textContent = 'Esperando escaneo...';
            copyButton.classList.add('hidden');
            toggleCameraButton.classList.add('hidden');
            isFrontCamera = false; // Resetear estado de la c치mara
            allCameras = []; // Limpiar la lista de c치maras
        }
        
        window.toggleCamera = async function() {
            // Solo alternamos si se detectaron m칰ltiples c치maras
            if (!html5Qrcode || allCameras.length <= 1) {
                showError("Solo se detect칩 una c치mara o el acceso a la lista de c치maras fall칩. No se puede alternar.");
                return;
            } 

            isFrontCamera = !isFrontCamera; // Alternar el estado
            
            // 1. Detener el escaneo actual
            await html5Qrcode.stop();
            
            // 2. Reiniciar el escaneo con la c치mara opuesta, usando facingMode
            await startCameraScan(isFrontCamera);
        }

        async function initializeScanner() {
            // Esperar a que la librer칤a se cargue antes de intentar usarla
            if (typeof Html5Qrcode === 'undefined') {
                console.log("Librer칤a Html5Qrcode a칰n no cargada. Reintentando...");
                setTimeout(initializeScanner, 100);
                return;
            }
            
            // Iniciar el escaneo con la l칩gica de detecci칩n y fallback
            startCameraScan(isFrontCamera);
        }
        
        /**
         * Intenta iniciar la c치mara usando la l칩gica de facingMode (trasera/frontal)
         * que es m치s robusta que usar IDs expl칤citos.
         */
        async function startCameraScan(useFront = false) {
            // Detener cualquier escaneo previo
            if (html5Qrcode) { await html5Qrcode.stop(); html5Qrcode = null; }
            
            html5Qrcode = new Html5Qrcode("qr-reader");

            // Configuraci칩n est치ndar del esc치ner
            const config = { fps: 10, qrbox: 250 }; 
            
            // Restricci칩n de c치mara basada en facingMode, que solicita la c치mara primaria o secundaria.
            const constraints = {
                facingMode: useFront ? "user" : "environment",
            };

            try {
                // 1. Intentar obtener la lista de c치maras (esto dispara el di치logo de permiso si no est치 almacenado)
                // Se hace antes del start para saber si hay m치s de una, pero si falla, se sigue con el start.
                try {
                    allCameras = await Html5Qrcode.getCameras();
                } catch (e) {
                    console.warn("Fallo al listar c치maras, se proceder치 solo con facingMode.");
                    allCameras = []; // Se fuerza a cero para desactivar el bot칩n de alternancia.
                }

                // 2. Iniciar el escaneo con la restricci칩n de facingMode
                await html5Qrcode.start(
                    constraints, 
                    config, 
                    onScanSuccess, 
                    onScanFailure
                );
                
                console.log(`Esc치ner iniciado con facingMode: ${useFront ? 'user' : 'environment'}.`);
                
                // Mostrar/Ocultar el bot칩n de alternancia
                if (allCameras.length > 1) {
                    toggleCameraButton.textContent = useFront ? 'Cambiar a C치mara Trasera' : 'Cambiar a C치mara Frontal';
                    toggleCameraButton.classList.remove('hidden');
                } else {
                    toggleCameraButton.classList.add('hidden');
                }
                
            } catch (err) {
                // Fallo final. Capturar el error y mostrar el mensaje de ayuda.
                let finalError = err.name || 'Error Desconocido';
                let message = `**${finalError}:** No se pudo iniciar el flujo de video.`;

                if (finalError === 'NotAllowedError' || finalError === 'PermissionDeniedError') {
                    message = `**${finalError}:** El permiso de la c치mara fue denegado por el usuario o por el navegador.`; 
                } else if (finalError === 'NotFoundError') {
                    message = `**${finalError}:** No se detect칩 ninguna c치mara accesible en tu dispositivo.`; 
                } else if (finalError === 'NotReadableError') {
                    message = `**${finalError}:** La c치mara est치 en uso por otra aplicaci칩n (Ej. WhatsApp o la app nativa de c치mara). Cierra esa aplicaci칩n y vuelve a intentar.`;
                }
                
                showError(message);
                console.error("Fallo total al iniciar c치mara:", err);
                // No llamamos a stopScanning aqu칤 para que el usuario pueda ver el mensaje de error.
            }
        }

        // Funci칩n llamada al hacer clic en el bot칩n de inicio
        window.startScanning = function() {
            // La UI de inicio se oculta y la vista de escaneo se muestra
            startScreen.style.display = 'none';
            scannerView.style.display = 'block';
            errorMessageDiv.classList.add('hidden'); // Ocultar errores previos
            
            // Iniciar el proceso de escaneo
            initializeScanner(); 
        }

        // Ocultar la vista del esc치ner al cargar la p치gina
        document.addEventListener('DOMContentLoaded', () => {
            scannerView.style.display = 'none';
        });

    </script>

</body>
</html>
