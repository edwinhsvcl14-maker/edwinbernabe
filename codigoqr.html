<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de Códigos QR Simple</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración del tema de Tailwind -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilo para que el contenedor del escáner sea visible cuando se active */
        .scanner-container {
            display: none;
        }
        /* Añadido para forzar la visibilidad del video */
        #qr-reader video {
            width: 100% !important;
            height: auto !important;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-lg bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">
            Escaner de Código QR111ww
        </h1>

        <!-- Opción 1: Botón de Inicio (Visible por defecto) -->
        <div id="start-screen" class="text-center p-8">
            <p class="text-gray-600 mb-8">
                Presiona el botón para activar tu cámara y comenzar a escanear.
            </p>
            <button id="start-button" 
                    class="w-full max-w-xs bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-lg transform hover:scale-105"
                    onclick="startScanning()">
                Escanear Código QR111ww
            </button>
        </div>

        <!-- Opción 2: Contenedor del Lector QR (Inicialmente oculto) -->
        <div id="scanner-view" class="scanner-container">
            <p class="text-center text-gray-500 mb-6">
                Apunta la cámara al código.
            </p>
            <div id="qr-reader" class="w-full rounded-lg overflow-hidden shadow-inner bg-gray-100 p-2 border border-gray-300">
                <!-- El video del escáner se insertará aquí -->
            </div>

            <!-- Sección de Resultados -->
            <div class="mt-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">Resultado del Escaneo</h2>
                
                <div id="qr-reader-results" class="bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300 min-h-[5rem] flex items-center justify-center">
                    <p id="result-text" class="text-gray-500 italic">Esperando escaneo...</p>
                </div>

                <!-- Botón para copiar resultado -->
                <button id="copy-button" 
                        class="hidden mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition duration-150 ease-in-out shadow-md"
                        onclick="copyToClipboard()">
                    Copiar Texto Escaneado
                </button>
                
                <!-- Botón para detener el escaneo -->
                <button id="stop-button" 
                        class="mt-2 w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg transition duration-150 ease-in-out shadow-md"
                        onclick="stopScanning()">
                    Detener Escaneo y Volver
                </button>
            </div>
        </div>
        
        <!-- Mensaje de Error (Inicialmente oculto) -->
        <div id="error-message" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Error:</strong>
            <!-- Mensaje de error general, se sobrescribe con mensajes específicos de JS -->
            <span id="error-details" class="block sm:inline">No se pudo acceder a la cámara. Revisa los permisos y asegúrate de usar HTTPS.</span>
        </div>
    </div>

    <!-- Script de la Librería html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

    <script>
        // Inicialización de constantes y elementos
        const startScreen = document.getElementById('start-screen');
        const scannerView = document.getElementById('scanner-view');
        const qrCodeResultDiv = document.getElementById('qr-reader-results');
        const resultTextElement = document.getElementById('result-text');
        const copyButton = document.getElementById('copy-button');
        const errorMessageDiv = document.getElementById('error-message');
        const errorDetailsSpan = document.getElementById('error-details');
        
        // Usamos el objeto Html5Qrcode directamente (más control)
        let html5Qrcode = null; 

        // --- FUNCIONES DE LÓGICA ---

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`, decodedResult);
            resultTextElement.innerHTML = `<a href="${decodedText}" target="_blank" class="text-indigo-600 hover:text-indigo-800 break-words">${decodedText}</a>`;
            qrCodeResultDiv.classList.add('bg-green-50');
            copyButton.classList.remove('hidden');
            copyButton.setAttribute('data-text', decodedText);
        }

        function onScanFailure(error) {
            // Manejo de errores de escaneo (cuando no se detecta QR)
        }

        function showError(message) {
            errorDetailsSpan.textContent = message;
            errorMessageDiv.classList.remove('hidden');
        }

        window.copyToClipboard = function() {
            const textToCopy = copyButton.getAttribute('data-text');
            const tempInput = document.createElement('textarea');
            document.body.appendChild(tempInput);
            tempInput.value = textToCopy;
            tempInput.select();
            
            try {
                document.execCommand('copy');
                copyButton.textContent = '¡Copiado!';
                setTimeout(() => {
                    copyButton.textContent = 'Copiar Texto Escaneado';
                }, 1500);
            } catch (err) {
                console.error('No se pudo copiar el texto:', err);
                copyButton.textContent = 'Error al Copiar';
            } finally {
                document.body.removeChild(tempInput);
            }
        }

        window.stopScanning = async function() {
            if (html5Qrcode) {
                try {
                    // Detener el objeto Html5Qrcode
                    await html5Qrcode.stop();
                    html5Qrcode = null;
                } catch (err) {
                    console.warn("Error al detener el escáner:", err);
                }
            }
            // Restaurar la interfaz
            scannerView.style.display = 'none';
            startScreen.style.display = 'block';
            errorMessageDiv.classList.add('hidden');
            qrCodeResultDiv.classList.remove('bg-green-50');
            resultTextElement.textContent = 'Esperando escaneo...';
            copyButton.classList.add('hidden');
        }
        
        // --- FUNCIÓN DE INICIALIZACIÓN (polling para asegurar la carga) ---
        async function initializeScanner() {
            // Utilizamos una función anidada para el polling de la librería
            function checkLibraryLoaded() {
                if (typeof Html5Qrcode === 'undefined') {
                    console.log("Esperando carga de Html5Qrcode...");
                    setTimeout(checkLibraryLoaded, 100);
                    return;
                }
                
                // Si la librería está cargada, procedemos a iniciar el escáner
                startCameraScan();
            }

            checkLibraryLoaded();
        }
        
        // --- FUNCIÓN QUE INICIA EL ESCANEO CON IDENTIFICACIÓN EXPLÍCITA DE CÁMARA Y RESOLUCIÓN ---
        async function startCameraScan() {
            // Aseguramos que la instancia anterior esté detenida
            if (html5Qrcode) {
                await stopScanning(); 
            }
            
            html5Qrcode = new Html5Qrcode("qr-reader");

            const config = { fps: 10, qrbox: 250 }; // Configuración básica de la librería

            try {
                // 1. Obtener la lista de cámaras disponibles
                const cameras = await Html5Qrcode.getCameras();
                
                if (cameras && cameras.length) {
                    let cameraId = null;
                    
                    // Buscar la cámara trasera por etiqueta
                    const rearCamera = cameras.find(camera => 
                        camera.label.toLowerCase().includes('back') || 
                        camera.label.toLowerCase().includes('environment')
                    );

                    if (rearCamera) {
                        cameraId = rearCamera.id;
                        console.log(`Usando cámara trasera por label: ${rearCamera.label}`);
                    } else if (cameras.length > 1) {
                         // Fallback: Si hay más de una, la última suele ser la trasera en móviles
                        cameraId = cameras[cameras.length - 1].id;
                        console.log("Usando última cámara detectada como fallback.");
                    } else {
                        // Si solo hay una cámara, usar esa
                        cameraId = cameras[0].id;
                        console.log("Usando la única cámara detectada.");
                    }
                    
                    // 2. Construir las restricciones de video, incluyendo el ID y la resolución ideal
                    const videoConstraints = {
                        deviceId: { exact: cameraId },
                        // Usamos ideal para que el navegador negocie una resolución cercana (alta compatibilidad)
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    };

                    // 3. Iniciar el escaneo con las restricciones explícitas
                    await html5Qrcode.start(
                        videoConstraints, // Pasamos el objeto de restricciones completo
                        config, 
                        onScanSuccess, 
                        onScanFailure
                    );
                    
                    console.log("Escáner iniciado con ID y resolución explícita.");

                } else {
                    showError("No se detectó ninguna cámara en este dispositivo. Asegúrate de que los permisos estén habilitados.");
                    stopScanning();
                    return;
                }
            } catch (err) {
                // Si falla por ID o resolución, intentamos un fallback genérico con facingMode
                console.error("Fallo con ID explícito. Intentando fallback con facingMode.", err);
                
                try {
                    // Fallback: Intentar con facingMode: environment y resolución estándar
                    const fallbackConstraints = {
                        facingMode: "environment",
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    };
                    await html5Qrcode.start(
                        fallbackConstraints, 
                        config, 
                        onScanSuccess, 
                        onScanFailure
                    );
                    console.log("Escáner iniciado con facingMode fallback.");
                } catch (e2) {
                    // 4. Fallo total
                    showError("Error crítico al iniciar el video de la cámara. Causa probable: Problema de compatibilidad de resolución o cámara ocupada.");
                    console.error("Fallo total al iniciar cámara:", e2);
                    stopScanning();
                    return;
                }
            }
            
            // Chequeo de estado después de 4 segundos (para detectar fallo de renderizado)
            setTimeout(() => {
                const videoElement = document.querySelector('#qr-reader video');
                // Si el elemento de video existe pero no tiene ancho, el flujo no se inició.
                if (!videoElement || videoElement.videoWidth === 0) { 
                    showError("El video no se renderizó. Asegúrate de que la página está en HTTPS y que el permiso fue aceptado. Intenta recargar.");
                    stopScanning();
                }
            }, 4000); 
        }


        // --- FUNCIÓN PARA SOLICITAR PERMISOS EXPLÍCITAMENTE ANTES DE INICIAR ---
        async function requestCameraPermission() {
            try {
                // Esto fuerza el pop-up de permiso del navegador
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                
                // Detenemos el stream nativo para que la librería html5-qrcode pueda tomar el control
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (err) {
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    showError("Permiso de cámara denegado. ¡Debes permitirlo! Revisa la configuración del sitio en tu navegador.");
                } else if (err.name === 'NotReadableError') {
                    showError("La cámara está en uso por otra aplicación. Ciérrala e inténtalo de nuevo.");
                } else {
                    showError(`Error al acceder a la cámara: ${err.name}. Asegúrate de usar una conexión HTTPS.`);
                }
                return false;
            }
        }

        // Función llamada al hacer clic en el botón de inicio
        window.startScanning = async function() {
            // 1. Intentar obtener permiso explícito
            const permissionGranted = await requestCameraPermission();
            
            if (!permissionGranted) {
                // Si el permiso fue denegado o hubo un error, ya se mostró el mensaje, y paramos.
                stopScanning();
                return;
            }

            // 2. Si hay permiso, proceder con la interfaz y la inicialización
            startScreen.style.display = 'none';
            scannerView.style.display = 'block';
            errorMessageDiv.classList.add('hidden');
            initializeScanner(); 
        }

        // Ocultar la vista del escáner al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            scannerView.style.display = 'none';
        });

    </script>

</body>
</html>
